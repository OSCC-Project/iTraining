# 布局合法化算法实现

### 1. 问题简介

​    布局流程中，可以分为三个阶段处理：总体布局(Global Placement)、合法化(Legalization)、详细布局(Detailed Placement)。在全局布局中把单元放到合适的位置，忽略单元重叠。合法化则是把单元放到行上，消除单元之间的重叠。

![全局布局、合法化、详细布局概述](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\1.png)

### 2. Abacus算法

#### 2.1 Abacus算法的动态规划思想

**定义优化问题**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\3.png)

**应用约束条件**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\4.png)

**简化和转换问题**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\5.png)

**计算最优位置**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\6.png)

**动态规划的实现**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\7.png)

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\8.png)

#### 2.2 Abacus算法的伪代码

![Abacus算法伪代码](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\2.png)

第1行：根据单元在全局放置中的 x 坐标对所有单元进行排序

第2行：遍历每个单元 `i`

第3行：为单元 `i` 初始化最佳代价`Cbest` 为无限大

第4-10行：遍历每一行 `r`

第5行：将单元 `i` 插入到行 `r`

第6行：对行 `r` 执行 `PlaceRow` 函数，进行试探性放置

第7行：确定放置单元 `i` 后行 `r` 的总代价 `c`

第8行：如果当前行的代价 `c` 小于之前的最佳代价 `Cbest`，则更新 `Cbest` 和最佳行 `rbest`

第9行：从行 `r` 中移除单元 `i`

第11行：将单元 `i` 放置到成本最低的行 `rbest`

第12行：对行 `rbest` 进行最终的 `PlaceRow` 操作

第13行：结束对所有单元的遍历

#### 2.3 PlaceRow函数

​    这段代码通过动态管理簇的创建、合并和单元的添加，优化每个单元在行中的位置，使得整体移动最小化。这种方法利用了簇的概念来高效地处理可能的重叠和位置调整，确保所有单元在法定位置上合理分布，从而达到最小的总移动距离。

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\9.png)

#### 2.4 Abacus算法流程图

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\Abacus算法流程图.png)

#### 2.5 iEDA中的Abacus算法实现

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\10.png)

### 3. Tetris算法

#### 3.1 Tetris算法流程图

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\Tetris算法流程图.png)

#### 3.2 Tetris算法实现

**根据元件的 x 坐标进行排序，对宽的元件赋予更高的权重**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\11.png)

**Tetris算法**

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\12.png)

### 4. 实验结果

#### 4.1 Abacu布局合法化结果

实验在工艺sky130，设计gcd下进行。

全局布局结束后，半周长线长为：10268089

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\13.png)

使用Abacus算法进行合法化，总移动量为：795709，运行时间为：0.014281s，半周长线长为：10438089

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\14.png)

#### 4.2 Tetris布局合法化结果

实验在工艺sky130，设计gcd下进行。

全局布局结束后，半周长线长为：10268089

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\15.png)

使用Tetris算法进行合法化，总移动量为：1473249，运行时间为：0.001208s，半周长线长为：10489260

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\16.png)

#### 4.3 其他特征统计信息

|                |  Abacus   |  Tetris   | 变化百分比 |
| :------------: | :-------: | :-------: | :--------: |
|  全局布局HPWL  | 10268089  | 10268089  |     0      |
| 布局合法化HPWL | 10438089  | 10489260  |   +0.49%   |
|  详细布局HPWL  |  9892338  |  9883234  |   -0.09%   |
|    总移动量    |  795709   |  1473249  |  +85.15%   |
|    运行时间    | 0.014341s | 0.001208s | -1087.17%  |
|   Total STWL   | 10777178  | 10751546  |   -0.24%   |
|    Max STWL    |  209533   |  231449   |  +10.46%   |

#### 4.4 在Tetris算法的排序中给宽度加入权重

​    Tetris算法的论文中，使用权重 width_factor，可以使得较宽的单元在进行详细放置排序时会被赋予更高的优先级。这样做的目的是在放置过程中优先处理宽的单元，确保在行或列中为这些大单元保留足够的空间，避免由于空间不足而无法合理放置。

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\17.png)

​    根据论文的介绍，如果利用率非常高（大于0.93），建议将 `width_factor` 设置为1.0；如果利用率较低（小于0.9），则可以将 `width_factor` 设置为较低的值，例如0.2。

![](C:\Users\苏坚荣\Desktop\PCL\iTraining\EDA\codes\2024-07\苏坚荣\Legalization\images\18.png)

​    以下实验在工艺sky130，设计gcd下进行。

|                | width_factor=0 | width_factor=0.2 | width_factor=0.5 | width_factor=1.0 |
| :------------: | :------------: | :--------------: | :--------------: | :--------------: |
|  全局布局HPWL  |    10268089    |     10268089     |     10268089     |     10268089     |
| 布局合法化HPWL |    10489260    |     10489260     |     10490384     |     10522030     |
|  详细布局HPWL  |    9883234     |     9883234      |     9884746      |     9883938      |
|    总移动量    |    1473249     |     1473249      |     1479503      |     1499905      |
|    运行时间    |   0.001208s    |     0.00131s     |    0.001227s     |    0.001305s     |
|   Total STWL   |    10751546    |     10751546     |     10837635     |     10932737     |
|    Max STWL    |     231449     |      231449      |      233369      |      233369      |